name: Notificar a Discord en push

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repo
        uses: actions/checkout@v3

      - name: Enviar mensaje a Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          AUTHOR_NAME="${{ github.actor }}"
          BRANCH="${GITHUB_REF##*/}"
          REPO="${{ github.repository }}"
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          COMMIT_URL="https://github.com/${REPO}/commit/${GITHUB_SHA}"

          JSON_PAYLOAD=$(jq -n \
            --arg author "$AUTHOR_NAME" \
            --arg branch "$BRANCH" \
            --arg repo "$REPO" \
            --arg hash "$COMMIT_HASH" \
            --arg message "$COMMIT_MESSAGE" \
            --arg url "$COMMIT_URL" \
            '{
              "embeds": [
                {
                  "title": "[" + $repo + ":" + $branch + "] 1 nuevo commit",
                  "url": $url,
                  "description": "`" + $hash + "` " + $message + " - " + $author
                }
              ]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               $DISCORD_WEBHOOK
